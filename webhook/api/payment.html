<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Payment - Razorpay</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: #0a0a0a;
            min-height: 100vh;
            padding: 24px 12px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .payment-container {
            background: #16213e;
            border: 1px solid rgba(124, 58, 237, 0.3);
            border-radius: 6px;
            max-width: 520px;
            width: 100%;
            padding: 24px;
        }

        .payment-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .payment-icon {
            width: 60px;
            height: 60px;
            background: #7c3aed;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 28px;
        }

        .payment-title {
            font-size: 16px;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 4px;
        }

        .payment-subtitle {
            font-size: 12px;
            color: #94a3b8;
        }

        .order-details {
            background: rgba(26, 26, 46, 0.6);
            border: 1px solid rgba(124, 58, 237, 0.2);
            border-radius: 4px;
            padding: 0;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            border-bottom: 1px solid rgba(124, 58, 237, 0.1);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-size: 12px;
            color: #94a3b8;
            font-weight: 500;
        }

        .detail-value {
            font-size: 12px;
            color: #e2e8f0;
            font-weight: 600;
        }

        .amount-row {
            background: #7c3aed;
            padding: 12px 14px;
            margin: 0;
            border-radius: 0;
        }

        .amount-row .detail-label,
        .amount-row .detail-value {
            color: #ffffff;
            font-size: 14px;
        }

        .pay-button {
            width: 100%;
            padding: 10px;
            background: #7c3aed;
            color: #ffffff;
            border: 1px solid #7c3aed;
            border-radius: 4px;
            font-size: 12.5px;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 16px;
        }

        .pay-button:hover {
            background: #6d28d9;
        }

        .pay-button:disabled {
            background: #475569;
            border-color: #475569;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .security-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 4px;
            margin-bottom: 16px;
        }

        .security-badge svg {
            width: 16px;
            height: 16px;
            fill: #10b981;
        }

        .security-text {
            font-size: 11px;
            color: #10b981;
            font-weight: 500;
        }

        .payment-methods {
            text-align: center;
            margin-top: 16px;
        }

        .methods-title {
            font-size: 11px;
            color: #64748b;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .methods-icons {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .method-icon {
            padding: 6px 12px;
            background: rgba(26, 26, 46, 0.6);
            border: 1px solid rgba(124, 58, 237, 0.2);
            border-radius: 4px;
            font-size: 11px;
            color: #cbd5e1;
            font-weight: 500;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 16px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(124, 58, 237, 0.2);
            border-top: 3px solid #7c3aed;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-message {
            display: none;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 16px;
            text-align: center;
            font-weight: 500;
            font-size: 12px;
            border-left: 3px solid;
        }

        .status-message.success {
            background: rgba(16, 185, 129, 0.1);
            color: #6ee7b7;
            border-left-color: #10b981;
            display: block;
        }

        .status-message.error {
            background: rgba(239, 68, 68, 0.1);
            color: #fca5a5;
            border-left-color: #ef4444;
            display: block;
        }

        @media (max-width: 640px) {
            .payment-container {
                padding: 16px;
            }

            .detail-row {
                padding: 8px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="payment-container">
        <div class="payment-header">
            <div class="payment-icon">üí≥</div>
            <h1 class="payment-title">Secure Payment</h1>
            <p class="payment-subtitle">Complete your order payment</p>
        </div>

        <div class="status-message" id="statusMessage"></div>

        <div class="order-details">
            <div class="detail-row">
                <span class="detail-label">Customer Name</span>
                <span class="detail-value" id="customerName">-</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Email</span>
                <span class="detail-value" id="customerEmail">-</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Order ID</span>
                <span class="detail-value" id="orderId">-</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Product</span>
                <span class="detail-value" id="productName">-</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Status</span>
                <span class="detail-value" id="orderStatus">-</span>
            </div>
            <div class="detail-row amount-row">
                <span class="detail-label">Total Amount</span>
                <span class="detail-value" id="amount">‚Çπ0</span>
            </div>
        </div>

        <div class="security-badge">
            <svg viewBox="0 0 24 24">
                <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
            </svg>
            <span class="security-text">üîí Secured by Razorpay - 100% Safe</span>
        </div>

        <button class="pay-button" id="payButton" onclick="initiatePayment()">
            Pay Now ‚Çπ<span id="payAmount">0</span>
        </button>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="color: #718096; font-size: 14px;">Processing payment...</p>
        </div>

        <div class="payment-methods">
            <p class="methods-title">Accepted Payment Methods</p>
            <div class="methods-icons">
                <span class="method-icon">üí≥ Cards</span>
                <span class="method-icon">üì± UPI</span>
                <span class="method-icon">üè¶ Net Banking</span>
                <span class="method-icon">üí∞ Wallets</span>
            </div>
        </div>
    </div>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('orderId');
        const amount = urlParams.get('amount');
        const productName = urlParams.get('product');
        const status = urlParams.get('status');
        const razorpayOrderId = urlParams.get('razorpay_order_id');
        const razorpayKey = urlParams.get('key');
        let customerName = urlParams.get('name');
        let customerEmail = urlParams.get('email');
        let customerPhone = urlParams.get('phone');

        const BASE_URL = 'https://nonchivalrous-paranoidly-cara.ngrok-free.dev';

        // Fetch customer data from order
        async function loadCustomerData() {
            try {
                if (orderId) {
                    const response = await fetch(`${BASE_URL}/api/get-order-customer?orderId=${orderId}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        customerName = data.customerName || customerName;
                        customerEmail = data.customerEmail || customerEmail;
                        customerPhone = data.customerPhone || customerPhone;
                        
                        // Update display
                        document.getElementById('customerName').textContent = customerName || 'Customer';
                        document.getElementById('customerEmail').textContent = customerEmail || 'N/A';
                    }
                }
            } catch (error) {
                console.error('Failed to load customer data:', error);
            }
        }

        // Display order details
        document.getElementById('customerName').textContent = decodeURIComponent(customerName || 'Customer');
        document.getElementById('customerEmail').textContent = decodeURIComponent(customerEmail || 'N/A');
        document.getElementById('orderId').textContent = orderId || 'N/A';
        document.getElementById('productName').textContent = decodeURIComponent(productName || 'N/A');
        document.getElementById('orderStatus').textContent = status || 'Pending';
        document.getElementById('amount').textContent = 'Rs. ' + (amount || '0');
        document.getElementById('payAmount').textContent = amount || '0';

        // Load customer data on page load
        loadCustomerData();

        async function initiatePayment() {
            if (!orderId || !amount) {
                showStatus('error', 'Invalid order details. Please try again.');
                return;
            }

            const payButton = document.getElementById('payButton');
            const loading = document.getElementById('loading');
            
            payButton.disabled = true;
            loading.classList.add('active');

            try {
                // If Razorpay order already created (from Deluge), use it directly
                if (razorpayOrderId && razorpayKey) {
                    openRazorpayCheckout(razorpayKey, razorpayOrderId, parseFloat(amount) * 100);
                    loading.classList.remove('active');
                    return;
                }

                // Otherwise, create Razorpay order via webhook
                const response = await fetch(`${BASE_URL}/api/create-razorpay-order`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: parseFloat(amount),
                        orderId: orderId,
                        currency: 'INR'
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || 'Failed to create payment order');
                }

                openRazorpayCheckout(data.key_id, data.razorpay_order_id, data.amount);
                loading.classList.remove('active');

            } catch (error) {
                console.error('Payment initiation error:', error);
                showStatus('error', error.message || 'Failed to initiate payment. Please try again.');
                payButton.disabled = false;
                loading.classList.remove('active');
            }
        }

        function openRazorpayCheckout(keyId, orderIdRzp, amountInPaise) {
            const payButton = document.getElementById('payButton');
            
            const options = {
                key: keyId,
                amount: amountInPaise,
                currency: 'INR',
                name: 'Your Store Name',
                description: `Payment for ${decodeURIComponent(productName || 'Order')}`,
                order_id: orderIdRzp,
                handler: function (response) {
                    verifyPayment(response);
                },
                prefill: {
                    name: decodeURIComponent(customerName || ''),
                    email: decodeURIComponent(customerEmail || ''),
                    contact: decodeURIComponent(customerPhone || '')
                },
                notes: {
                    order_id: orderId
                },
                theme: {
                    color: '#667eea'
                },
                modal: {
                    ondismiss: function() {
                        payButton.disabled = false;
                        showStatus('error', 'Payment cancelled. Please try again.');
                    }
                }
            };

            const rzp = new Razorpay(options);
            rzp.open();
        }

        async function verifyPayment(response) {
            const loading = document.getElementById('loading');
            loading.classList.add('active');

            try {
                const verifyResponse = await fetch(`${BASE_URL}/api/verify-razorpay-payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        razorpay_order_id: response.razorpay_order_id,
                        razorpay_payment_id: response.razorpay_payment_id,
                        razorpay_signature: response.razorpay_signature,
                        order_id: orderId
                    })
                });

                const data = await verifyResponse.json();

                if (data.success) {
                    // Update status to Paid
                    document.getElementById('orderStatus').textContent = 'Paid';
                    document.getElementById('orderStatus').style.color = '#10b981';
                    document.getElementById('orderStatus').style.fontWeight = 'bold';
                    
                    showStatus('success', '‚úÖ Payment successful! Downloading receipt...');
                    
                    // Generate and download receipt
                    setTimeout(() => {
                        generateReceipt(response);
                    }, 1000);
                    
                    // Close window after 5 seconds
                    setTimeout(() => {
                        window.close();
                    }, 5000);
                } else {
                    showStatus('error', '‚ùå Payment verification failed. Please contact support.');
                }

            } catch (error) {
                console.error('Payment verification error:', error);
                showStatus('error', '‚ùå Payment verification failed. Please contact support.');
            } finally {
                loading.classList.remove('active');
            }
        }

        function showStatus(type, message) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.className = `status-message ${type}`;
            statusMessage.textContent = message;
        }

        function generateReceipt(paymentResponse) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Get customer details from displayed page values
            const customerNameDecoded = document.getElementById('customerName').textContent;
            const customerEmailDecoded = document.getElementById('customerEmail').textContent;
            const productDecoded = document.getElementById('productName').textContent;
            const orderAmount = String(amount || '0');
            const orderIdValue = document.getElementById('orderId').textContent;
            
            // Header
            doc.setFillColor(102, 126, 234);
            doc.rect(0, 0, 210, 40, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('PAYMENT RECEIPT', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('Your Store Name', 105, 30, { align: 'center' });
            
            // Reset text color
            doc.setTextColor(0, 0, 0);
            
            // Receipt details
            let yPos = 60;
            
            // Transaction Info
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Transaction Details', 20, yPos);
            yPos += 10;
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            
            const details = [
                ['Payment ID:', String(paymentResponse.razorpay_payment_id)],
                ['Order ID:', String(orderIdValue)],
                ['Date:', new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' })],
                ['Status:', 'PAID'],
                ['', ''],
                ['Customer Information', ''],
                ['Name:', String(customerNameDecoded)],
                ['Email:', String(customerEmailDecoded)],
                ['', ''],
                ['Order Information', ''],
                ['Product:', String(productDecoded)],
                ['Amount:', 'Rs. ' + String(orderAmount)]
            ];
            
            details.forEach(([label, value]) => {
                if (label === 'Customer Information' || label === 'Order Information') {
                    yPos += 5;
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(14);
                    doc.text(label, 20, yPos);
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(11);
                    yPos += 8;
                } else if (label) {
                    doc.setFont(undefined, 'bold');
                    doc.text(label, 20, yPos);
                    doc.setFont(undefined, 'normal');
                    doc.text(value, 70, yPos);
                    yPos += 8;
                }
            });
            
            // Total amount box
            yPos += 10;
            doc.setFillColor(102, 126, 234);
            doc.rect(20, yPos, 170, 15, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Total Amount Paid:', 25, yPos + 10);
            doc.text('Rs. ' + String(orderAmount), 185, yPos + 10, { align: 'right' });
            
            // Footer
            doc.setTextColor(128, 128, 128);
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('Thank you for your payment!', 105, 270, { align: 'center' });
            doc.text('Powered by Razorpay - 100% Secure', 105, 280, { align: 'center' });
            
            // Download PDF with customer name
            const fileName = `Receipt_${customerNameDecoded.replace(/\s+/g, '_')}_${orderIdValue}.pdf`;
            doc.save(fileName);
            
            console.log('‚úÖ Receipt downloaded:', fileName);
        }

        // Auto-initiate payment on page load (optional)
        // Uncomment the line below if you want automatic payment popup
        // window.onload = initiatePayment;
    </script>
</body>
</html>
