<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Payment - Razorpay</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .payment-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            padding: 40px;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .payment-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .payment-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 40px;
        }

        .payment-title {
            font-size: 28px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .payment-subtitle {
            font-size: 14px;
            color: #718096;
        }

        .order-details {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-size: 14px;
            color: #718096;
            font-weight: 500;
        }

        .detail-value {
            font-size: 14px;
            color: #2d3748;
            font-weight: 600;
        }

        .amount-row {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: -20px -20px 0 -20px;
            padding: 20px;
            border-radius: 0 0 12px 12px;
        }

        .amount-row .detail-label,
        .amount-row .detail-value {
            color: white;
            font-size: 18px;
        }

        .pay-button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            margin-bottom: 20px;
        }

        .pay-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .pay-button:active {
            transform: translateY(0);
        }

        .pay-button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            box-shadow: none;
        }

        .security-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 15px;
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .security-badge svg {
            width: 20px;
            height: 20px;
            fill: #38a169;
        }

        .security-text {
            font-size: 13px;
            color: #2f855a;
            font-weight: 600;
        }

        .payment-methods {
            text-align: center;
            margin-top: 20px;
        }

        .methods-title {
            font-size: 12px;
            color: #a0aec0;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .methods-icons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .method-icon {
            padding: 8px 16px;
            background: #f7fafc;
            border-radius: 6px;
            font-size: 12px;
            color: #4a5568;
            font-weight: 600;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-message {
            display: none;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .status-message.success {
            background: #f0fff4;
            color: #2f855a;
            border: 1px solid #9ae6b4;
            display: block;
        }

        .status-message.error {
            background: #fff5f5;
            color: #c53030;
            border: 1px solid #fc8181;
            display: block;
        }

        @media (max-width: 480px) {
            .payment-container {
                padding: 30px 20px;
            }

            .payment-title {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="payment-container">
        <div class="payment-header">
            <div class="payment-icon">üí≥</div>
            <h1 class="payment-title">Secure Payment</h1>
            <p class="payment-subtitle">Complete your order payment</p>
        </div>

        <div class="status-message" id="statusMessage"></div>

        <div class="order-details">
            <div class="detail-row">
                <span class="detail-label">Customer Name</span>
                <span class="detail-value" id="customerName">-</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Email</span>
                <span class="detail-value" id="customerEmail">-</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Order ID</span>
                <span class="detail-value" id="orderId">-</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Product</span>
                <span class="detail-value" id="productName">-</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Status</span>
                <span class="detail-value" id="orderStatus">-</span>
            </div>
            <div class="detail-row amount-row">
                <span class="detail-label">Total Amount</span>
                <span class="detail-value" id="amount">‚Çπ0</span>
            </div>
        </div>

        <div class="security-badge">
            <svg viewBox="0 0 24 24">
                <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
            </svg>
            <span class="security-text">üîí Secured by Razorpay - 100% Safe</span>
        </div>

        <button class="pay-button" id="payButton" onclick="initiatePayment()">
            Pay Now ‚Çπ<span id="payAmount">0</span>
        </button>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="color: #718096; font-size: 14px;">Processing payment...</p>
        </div>

        <div class="payment-methods">
            <p class="methods-title">Accepted Payment Methods</p>
            <div class="methods-icons">
                <span class="method-icon">üí≥ Cards</span>
                <span class="method-icon">üì± UPI</span>
                <span class="method-icon">üè¶ Net Banking</span>
                <span class="method-icon">üí∞ Wallets</span>
            </div>
        </div>
    </div>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('orderId');
        const amount = urlParams.get('amount');
        const productName = urlParams.get('product');
        const status = urlParams.get('status');
        const razorpayOrderId = urlParams.get('razorpay_order_id');
        const razorpayKey = urlParams.get('key');
        const customerName = urlParams.get('name');
        const customerEmail = urlParams.get('email');
        const customerPhone = urlParams.get('phone');

        // Display order details
        document.getElementById('customerName').textContent = decodeURIComponent(customerName || 'Customer');
        document.getElementById('customerEmail').textContent = decodeURIComponent(customerEmail || 'N/A');
        document.getElementById('orderId').textContent = orderId || 'N/A';
        document.getElementById('productName').textContent = decodeURIComponent(productName || 'N/A');
        document.getElementById('orderStatus').textContent = status || 'Pending';
        document.getElementById('amount').textContent = 'Rs. ' + (amount || '0');
        document.getElementById('payAmount').textContent = amount || '0';

        const BASE_URL = 'https://nonchivalrous-paranoidly-cara.ngrok-free.dev';

        async function initiatePayment() {
            if (!orderId || !amount) {
                showStatus('error', 'Invalid order details. Please try again.');
                return;
            }

            const payButton = document.getElementById('payButton');
            const loading = document.getElementById('loading');
            
            payButton.disabled = true;
            loading.classList.add('active');

            try {
                // If Razorpay order already created (from Deluge), use it directly
                if (razorpayOrderId && razorpayKey) {
                    openRazorpayCheckout(razorpayKey, razorpayOrderId, parseFloat(amount) * 100);
                    loading.classList.remove('active');
                    return;
                }

                // Otherwise, create Razorpay order via webhook
                const response = await fetch(`${BASE_URL}/api/create-razorpay-order`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: parseFloat(amount),
                        orderId: orderId,
                        currency: 'INR'
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || 'Failed to create payment order');
                }

                openRazorpayCheckout(data.key_id, data.razorpay_order_id, data.amount);
                loading.classList.remove('active');

            } catch (error) {
                console.error('Payment initiation error:', error);
                showStatus('error', error.message || 'Failed to initiate payment. Please try again.');
                payButton.disabled = false;
                loading.classList.remove('active');
            }
        }

        function openRazorpayCheckout(keyId, orderIdRzp, amountInPaise) {
            const payButton = document.getElementById('payButton');
            
            const options = {
                key: keyId,
                amount: amountInPaise,
                currency: 'INR',
                name: 'Your Store Name',
                description: `Payment for ${decodeURIComponent(productName || 'Order')}`,
                order_id: orderIdRzp,
                handler: function (response) {
                    verifyPayment(response);
                },
                prefill: {
                    name: decodeURIComponent(customerName || ''),
                    email: decodeURIComponent(customerEmail || ''),
                    contact: decodeURIComponent(customerPhone || '')
                },
                notes: {
                    order_id: orderId
                },
                theme: {
                    color: '#667eea'
                },
                modal: {
                    ondismiss: function() {
                        payButton.disabled = false;
                        showStatus('error', 'Payment cancelled. Please try again.');
                    }
                }
            };

            const rzp = new Razorpay(options);
            rzp.open();
        }

        async function verifyPayment(response) {
            const loading = document.getElementById('loading');
            loading.classList.add('active');

            try {
                const verifyResponse = await fetch(`${BASE_URL}/api/verify-razorpay-payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        razorpay_order_id: response.razorpay_order_id,
                        razorpay_payment_id: response.razorpay_payment_id,
                        razorpay_signature: response.razorpay_signature,
                        order_id: orderId
                    })
                });

                const data = await verifyResponse.json();

                if (data.success) {
                    // Update status to Paid
                    const statusElement = document.querySelector('.detail-row:nth-child(3) .detail-value');
                    if (statusElement) {
                        statusElement.textContent = 'Paid';
                        statusElement.style.color = '#10b981';
                        statusElement.style.fontWeight = 'bold';
                    }
                    
                    showStatus('success', '‚úÖ Payment successful! Downloading receipt...');
                    
                    // Generate and download receipt
                    setTimeout(() => {
                        generateReceipt(response);
                    }, 1000);
                    
                    // Close window after 5 seconds
                    setTimeout(() => {
                        window.close();
                    }, 5000);
                } else {
                    showStatus('error', '‚ùå Payment verification failed. Please contact support.');
                }

            } catch (error) {
                console.error('Payment verification error:', error);
                showStatus('error', '‚ùå Payment verification failed. Please contact support.');
            } finally {
                loading.classList.remove('active');
            }
        }

        function showStatus(type, message) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.className = `status-message ${type}`;
            statusMessage.textContent = message;
        }

        function generateReceipt(paymentResponse) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Get customer details from displayed page values
            const customerNameDecoded = document.getElementById('customerName').textContent;
            const customerEmailDecoded = document.getElementById('customerEmail').textContent;
            const productDecoded = document.getElementById('productName').textContent;
            const orderAmount = String(amount || '0');
            const orderIdValue = document.getElementById('orderId').textContent;
            
            // Header
            doc.setFillColor(102, 126, 234);
            doc.rect(0, 0, 210, 40, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('PAYMENT RECEIPT', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('Your Store Name', 105, 30, { align: 'center' });
            
            // Reset text color
            doc.setTextColor(0, 0, 0);
            
            // Receipt details
            let yPos = 60;
            
            // Transaction Info
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Transaction Details', 20, yPos);
            yPos += 10;
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            
            const details = [
                ['Payment ID:', String(paymentResponse.razorpay_payment_id)],
                ['Order ID:', String(orderIdValue)],
                ['Date:', new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' })],
                ['Status:', 'PAID'],
                ['', ''],
                ['Customer Information', ''],
                ['Name:', String(customerNameDecoded)],
                ['Email:', String(customerEmailDecoded)],
                ['', ''],
                ['Order Information', ''],
                ['Product:', String(productDecoded)],
                ['Amount:', 'Rs. ' + String(orderAmount)]
            ];
            
            details.forEach(([label, value]) => {
                if (label === 'Customer Information' || label === 'Order Information') {
                    yPos += 5;
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(14);
                    doc.text(label, 20, yPos);
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(11);
                    yPos += 8;
                } else if (label) {
                    doc.setFont(undefined, 'bold');
                    doc.text(label, 20, yPos);
                    doc.setFont(undefined, 'normal');
                    doc.text(value, 70, yPos);
                    yPos += 8;
                }
            });
            
            // Total amount box
            yPos += 10;
            doc.setFillColor(102, 126, 234);
            doc.rect(20, yPos, 170, 15, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Total Amount Paid:', 25, yPos + 10);
            doc.text('Rs. ' + String(orderAmount), 185, yPos + 10, { align: 'right' });
            
            // Footer
            doc.setTextColor(128, 128, 128);
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('Thank you for your payment!', 105, 270, { align: 'center' });
            doc.text('Powered by Razorpay - 100% Secure', 105, 280, { align: 'center' });
            
            // Download PDF with customer name
            const fileName = `Receipt_${customerNameDecoded.replace(/\s+/g, '_')}_${orderIdValue}.pdf`;
            doc.save(fileName);
            
            console.log('‚úÖ Receipt downloaded:', fileName);
        }

        // Auto-initiate payment on page load (optional)
        // Uncomment the line below if you want automatic payment popup
        // window.onload = initiatePayment;
    </script>
</body>
</html>
